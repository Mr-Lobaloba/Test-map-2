class E{constructor(t){this.properties=t??[]}get(t){const r=this.properties.filter(o=>o.name===t).map(o=>o.value);if(r.length>1)throw new Error('Expected only one property to be named "'+t+'"');if(r.length!==0)return r[0]}getString(t){return this.getByType(t,"string")}getNumber(t){return this.getByType(t,"number")}getBoolean(t){return this.getByType(t,"boolean")}getByType(t,r){const o=this.get(t);if(o!==void 0){if(r!=="json"&&typeof o!==r)throw new Error('Expected property "'+t+'" to have type "'+r+'"');return o}}mustGetString(t){return this.mustGetByType(t,"string")}mustGetNumber(t){return this.mustGetByType(t,"number")}mustGetBoolean(t){return this.mustGetByType(t,"boolean")}mustGetByType(t,r){const o=this.get(t);if(o===void 0)throw new Error('Property "'+t+'" is missing');if(r!=="json"&&typeof o!==r)throw new Error('Expected property "'+t+'" to have type "'+r+'"');return o}getType(t){const r=this.properties.filter(o=>o.name===t).map(o=>o.type);if(r.length>1)throw new Error('Expected only one property to be named "'+t+'"');if(r.length!==0)return r[0]}}const B="https://unpkg.com/@workadventure/scripting-api-extra@1.4.6/dist";class ee{constructor(t){this.name=t.name,this.x=t.x,this.y=t.y,this.properties=new E(t.properties)}get isReadable(){const t=this.properties.getString("readableBy");return t?WA.player.tags.includes(t):!0}get isWritable(){const t=this.properties.getString("writableBy");return t?WA.player.tags.includes(t):!0}}function N(e){const t=e?"#"+e.join():"";WA.nav.openCoWebSite(B+"/configuration.html"+t)}async function te(e,t){const r=await WA.room.getTiledMap(),o=new Map;return z(r.layers,o,e,t),o}function z(e,t,r,o){for(const n of e)if(n.type==="objectgroup"){for(const s of n.objects)if(s.type==="variable"||s.class==="variable"){if(r&&n.name!==r||o&&!o.includes(s.name))continue;t.set(s.name,new ee(s))}}else n.type==="group"&&z(n.layers,t,r,o)}let j;async function x(){return j===void 0&&(j=re()),j}async function re(){return oe(await WA.room.getTiledMap())}function oe(e){const t=new Map;return F(e.layers,"",t),t}function F(e,t,r){for(const o of e)o.type==="group"?F(o.layers,t+o.name+"/",r):(o.name=t+o.name,r.set(o.name,o))}async function ne(){const e=await x(),t=[];for(const r of e.values())if(r.type==="objectgroup")for(const o of r.objects)(o.type==="area"||o.class==="area")&&t.push(o);return t}function se(e){let t=1/0,r=1/0,o=0,n=0;const s=e.data;if(typeof s=="string")throw new Error("Unsupported tile layer data stored as string instead of CSV");for(let i=0;i<e.height;i++)for(let a=0;a<e.width;a++)s[a+i*e.width]!==0&&(t=Math.min(t,a),n=Math.max(n,a),r=Math.min(r,i),o=Math.max(o,i));return{top:r,left:t,right:n+1,bottom:o+1}}function J(e){let t=1/0,r=1/0,o=0,n=0;for(const s of e){const i=se(s);i.left<t&&(t=i.left),i.top<r&&(r=i.top),i.right>n&&(n=i.right),i.bottom>o&&(o=i.bottom)}return{top:r,left:t,right:n,bottom:o}}/*!
* mustache.js - Logic-less {{mustache}} templates with JavaScript
* http://github.com/janl/mustache.js
*/var ie=Object.prototype.toString,W=Array.isArray||function(e){return ie.call(e)==="[object Array]"};function I(e){return typeof e=="function"}function ae(e){return W(e)?"array":typeof e}function G(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function _(e,t){return e!=null&&typeof e=="object"&&t in e}function ce(e,t){return e!=null&&typeof e!="object"&&e.hasOwnProperty&&e.hasOwnProperty(t)}var le=RegExp.prototype.test;function ue(e,t){return le.call(e,t)}var pe=/\S/;function fe(e){return!ue(pe,e)}var he={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function ge(e){return String(e).replace(/[&<>"'`=\/]/g,function(t){return he[t]})}var de=/\s*/,ye=/\s+/,q=/\s*=/,me=/\s*\}/,ve=/#|\^|\/|>|\{|&|=|!/;function be(e,t){if(!e)return[];var r=!1,o=[],n=[],s=[],i=!1,a=!1,c="",u=0;function d(){if(i&&!a)for(;s.length;)delete n[s.pop()];else s=[];i=!1,a=!1}var m,v,L;function S(b){if(typeof b=="string"&&(b=b.split(ye,2)),!W(b)||b.length!==2)throw new Error("Invalid tags: "+b);m=new RegExp(G(b[0])+"\\s*"),v=new RegExp("\\s*"+G(b[1])),L=new RegExp("\\s*"+G("}"+b[1]))}S(t||h.tags);for(var l=new P(e),y,f,g,C,V,w;!l.eos();){if(y=l.pos,g=l.scanUntil(m),g)for(var k=0,Z=g.length;k<Z;++k)C=g.charAt(k),fe(C)?(s.push(n.length),c+=C):(a=!0,r=!0,c+=" "),n.push(["text",C,y,y+1]),y+=1,C===`
`&&(d(),c="",u=0,r=!1);if(!l.scan(m))break;if(i=!0,f=l.scan(ve)||"name",l.scan(de),f==="="?(g=l.scanUntil(q),l.scan(q),l.scanUntil(v)):f==="{"?(g=l.scanUntil(L),l.scan(me),l.scanUntil(v),f="&"):g=l.scanUntil(v),!l.scan(v))throw new Error("Unclosed tag at "+l.pos);if(f==">"?V=[f,g,y,l.pos,c,u,r]:V=[f,g,y,l.pos],u++,n.push(V),f==="#"||f==="^")o.push(V);else if(f==="/"){if(w=o.pop(),!w)throw new Error('Unopened section "'+g+'" at '+y);if(w[1]!==g)throw new Error('Unclosed section "'+w[1]+'" at '+y)}else f==="name"||f==="{"||f==="&"?a=!0:f==="="&&S(g)}if(d(),w=o.pop(),w)throw new Error('Unclosed section "'+w[1]+'" at '+l.pos);return Ae(we(n))}function we(e){for(var t=[],r,o,n=0,s=e.length;n<s;++n)r=e[n],r&&(r[0]==="text"&&o&&o[0]==="text"?(o[1]+=r[1],o[3]=r[3]):(t.push(r),o=r));return t}function Ae(e){for(var t=[],r=t,o=[],n,s,i=0,a=e.length;i<a;++i)switch(n=e[i],n[0]){case"#":case"^":r.push(n),o.push(n),r=n[4]=[];break;case"/":s=o.pop(),s[5]=n[2],r=o.length>0?o[o.length-1][4]:t;break;default:r.push(n)}return t}function P(e){this.string=e,this.tail=e,this.pos=0}P.prototype.eos=function(){return this.tail===""};P.prototype.scan=function(e){var t=this.tail.match(e);if(!t||t.index!==0)return"";var r=t[0];return this.tail=this.tail.substring(r.length),this.pos+=r.length,r};P.prototype.scanUntil=function(e){var t=this.tail.search(e),r;switch(t){case-1:r=this.tail,this.tail="";break;case 0:r="";break;default:r=this.tail.substring(0,t),this.tail=this.tail.substring(t)}return this.pos+=r.length,r};function A(e,t){this.view=e,this.cache={".":this.view},this.parent=t}A.prototype.push=function(e){return new A(e,this)};A.prototype.lookup=function(e){var t=this.cache,r;if(t.hasOwnProperty(e))r=t[e];else{for(var o=this,n,s,i,a=!1;o;){if(e.indexOf(".")>0)for(n=o.view,s=e.split("."),i=0;n!=null&&i<s.length;)i===s.length-1&&(a=_(n,s[i])||ce(n,s[i])),n=n[s[i++]];else n=o.view[e],a=_(o.view,e);if(a){r=n;break}o=o.parent}t[e]=r}return I(r)&&(r=r.call(this.view)),r};function p(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}p.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};p.prototype.parse=function(e,t){var r=this.templateCache,o=e+":"+(t||h.tags).join(":"),n=typeof r<"u",s=n?r.get(o):void 0;return s==null&&(s=be(e,t),n&&r.set(o,s)),s};p.prototype.render=function(e,t,r,o){var n=this.getConfigTags(o),s=this.parse(e,n),i=t instanceof A?t:new A(t,void 0);return this.renderTokens(s,i,r,e,o)};p.prototype.renderTokens=function(e,t,r,o,n){for(var s="",i,a,c,u=0,d=e.length;u<d;++u)c=void 0,i=e[u],a=i[0],a==="#"?c=this.renderSection(i,t,r,o,n):a==="^"?c=this.renderInverted(i,t,r,o,n):a===">"?c=this.renderPartial(i,t,r,n):a==="&"?c=this.unescapedValue(i,t):a==="name"?c=this.escapedValue(i,t,n):a==="text"&&(c=this.rawValue(i)),c!==void 0&&(s+=c);return s};p.prototype.renderSection=function(e,t,r,o,n){var s=this,i="",a=t.lookup(e[1]);function c(m){return s.render(m,t,r,n)}if(a){if(W(a))for(var u=0,d=a.length;u<d;++u)i+=this.renderTokens(e[4],t.push(a[u]),r,o,n);else if(typeof a=="object"||typeof a=="string"||typeof a=="number")i+=this.renderTokens(e[4],t.push(a),r,o,n);else if(I(a)){if(typeof o!="string")throw new Error("Cannot use higher-order sections without the original template");a=a.call(t.view,o.slice(e[3],e[5]),c),a!=null&&(i+=a)}else i+=this.renderTokens(e[4],t,r,o,n);return i}};p.prototype.renderInverted=function(e,t,r,o,n){var s=t.lookup(e[1]);if(!s||W(s)&&s.length===0)return this.renderTokens(e[4],t,r,o,n)};p.prototype.indentPartial=function(e,t,r){for(var o=t.replace(/[^ \t]/g,""),n=e.split(`
`),s=0;s<n.length;s++)n[s].length&&(s>0||!r)&&(n[s]=o+n[s]);return n.join(`
`)};p.prototype.renderPartial=function(e,t,r,o){if(r){var n=this.getConfigTags(o),s=I(r)?r(e[1]):r[e[1]];if(s!=null){var i=e[6],a=e[5],c=e[4],u=s;a==0&&c&&(u=this.indentPartial(s,c,i));var d=this.parse(u,n);return this.renderTokens(d,t,r,u,o)}}};p.prototype.unescapedValue=function(e,t){var r=t.lookup(e[1]);if(r!=null)return r};p.prototype.escapedValue=function(e,t,r){var o=this.getConfigEscape(r)||h.escape,n=t.lookup(e[1]);if(n!=null)return typeof n=="number"&&o===h.escape?String(n):o(n)};p.prototype.rawValue=function(e){return e[1]};p.prototype.getConfigTags=function(e){return W(e)?e:e&&typeof e=="object"?e.tags:void 0};p.prototype.getConfigEscape=function(e){if(e&&typeof e=="object"&&!W(e))return e.escape};var h={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){T.templateCache=e},get templateCache(){return T.templateCache}},T=new p;h.clearCache=function(){return T.clearCache()};h.parse=function(e,t){return T.parse(e,t)};h.render=function(e,t,r,o){if(typeof e!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+ae(e)+'" was given as the first argument for mustache#render(template, view, partials)');return T.render(e,t,r,o)};h.escape=ge;h.Scanner=P;h.Context=A;h.Writer=p;class Q{constructor(t,r){this.template=t,this.state=r,this.ast=h.parse(t)}getValue(){return this.value===void 0&&(this.value=h.render(this.template,this.state)),this.value}onChange(t){const r=[];for(const o of this.getUsedVariables().values())r.push(this.state.onVariableChange(o).subscribe(()=>{const n=h.render(this.template,this.state);n!==this.value&&(this.value=n,t(this.value))}));return{unsubscribe:()=>{for(const o of r)o.unsubscribe()}}}isPureString(){return this.ast.length===0||this.ast.length===1&&this.ast[0][0]==="text"}getUsedVariables(){const t=new Set;return this.recursiveGetUsedVariables(this.ast,t),t}recursiveGetUsedVariables(t,r){for(const o of t){const n=o[0],s=o[1],i=o[4];["name","&","#","^"].includes(n)&&r.add(s),i!==void 0&&typeof i!="string"&&this.recursiveGetUsedVariables(i,r)}}}async function We(){var e;const t=await ne();for(const r of t){const o=(e=r.properties)!==null&&e!==void 0?e:[];for(const n of o){if(n.type==="int"||n.type==="bool"||n.type==="object"||typeof n.value!="string")continue;const s=new Q(n.value,WA.state);if(s.isPureString())continue;const i=s.getValue();await D(r.name,n.name,i),s.onChange(async a=>{await D(r.name,n.name,a)})}}}async function Se(){var e;const t=await x();for(const[r,o]of t.entries())if(o.type!=="objectgroup"){const n=(e=o.properties)!==null&&e!==void 0?e:[];for(const s of n){if(s.type==="int"||s.type==="bool"||s.type==="object"||typeof s.value!="string")continue;const i=new Q(s.value,WA.state);if(i.isPureString())continue;const a=i.getValue();$(r,s.name,a),i.onChange(c=>{$(r,s.name,c)})}}}async function D(e,t,r){console.log(e),(await WA.room.area.get(e)).setProperty(t,r)}function $(e,t,r){WA.room.setProperty(e,t,r),t==="visible"&&(r?WA.room.showLayer(e):WA.room.hideLayer(e))}let U,R=0,O=0;function H(e){if(WA.state[e.name]){let t=e.properties.mustGetString("openLayer");for(const r of t.split(`
`))WA.room.showLayer(r);t=e.properties.mustGetString("closeLayer");for(const r of t.split(`
`))WA.room.hideLayer(r)}else{let t=e.properties.mustGetString("openLayer");for(const r of t.split(`
`))WA.room.hideLayer(r);t=e.properties.mustGetString("closeLayer");for(const r of t.split(`
`))WA.room.showLayer(r)}}function Ce(e){const t=e.properties.getString("openSound"),r=e.properties.getNumber("soundRadius");let o=1;if(r){const n=Y(e.properties.mustGetString("openLayer").split(`
`));if(n>r)return;o=1-n/r}t&&WA.sound.loadSound(t).play({volume:o})}function Ee(e){const t=e.properties.getString("closeSound"),r=e.properties.getNumber("soundRadius");let o=1;if(r){const n=Y(e.properties.mustGetString("closeLayer").split(`
`));if(n>r)return;o=1-n/r}t&&WA.sound.loadSound(t).play({volume:o})}function X(e){return e.map(t=>U.get(t)).filter(t=>(t==null?void 0:t.type)==="tilelayer")}function Y(e){const t=X(e),r=J(t),o=((r.right-r.left)/2+r.left)*32,n=((r.bottom-r.top)/2+r.top)*32;return Math.sqrt(Math.pow(R-o,2)+Math.pow(O-n,2))}function Te(e){WA.state.onVariableChange(e.name).subscribe(()=>{WA.state[e.name]?Ce(e):Ee(e),H(e)}),H(e)}function xe(e,t,r,o){const n=e.name;let s,i,a=!1;const c=r.getString("tag");let u=!0;c&&!WA.player.tags.includes(c)&&(u=!1);const d=!!c;function m(){var l;s&&s.remove(),s=WA.ui.displayActionMessage({message:(l=r.getString("closeTriggerMessage"))!==null&&l!==void 0?l:"Press SPACE to close the door",callback:()=>{WA.state[t.name]=!1,v()}})}function v(){var l;s&&s.remove(),s=WA.ui.displayActionMessage({message:(l=r.getString("openTriggerMessage"))!==null&&l!==void 0?l:"Press SPACE to open the door",callback:()=>{WA.state[t.name]=!0,m()}})}function L(l){const y=J(X(t.properties.mustGetString("closeLayer").split(`
`)));i=WA.room.website.create({name:"doorKeypad"+l,url:o+"/keypad.html#"+encodeURIComponent(l),position:{x:y.right*32,y:y.top*32,width:32*3,height:32*4},allowApi:!0})}function S(){i&&(WA.room.website.delete(i.name),i=void 0)}WA.room.onEnterLayer(n).subscribe(()=>{if(a=!0,r.getBoolean("autoOpen")&&u){WA.state[t.name]=!0;return}if(!WA.state[t.name]&&(d&&!u||!d)&&(r.getString("code")||r.getString("codeVariable"))){L(n);return}u&&(WA.state[t.name]?m():v())}),WA.room.onLeaveLayer(n).subscribe(()=>{a=!1,r.getBoolean("autoClose")&&(WA.state[t.name]=!1),s&&s.remove(),S()}),WA.state.onVariableChange(t.name).subscribe(()=>{a&&(!r.getBoolean("autoClose")&&WA.state[t.name]===!0&&m(),i&&WA.state[t.name]===!0&&S(),!r.getBoolean("autoOpen")&&WA.state[t.name]===!1&&v())})}function Pe(e){const t=e.properties.mustGetString("bellSound"),r=e.properties.getNumber("soundRadius");let o=1;if(r){const n=Math.sqrt(Math.pow(e.x-R,2)+Math.pow(e.y-O,2));if(n>r)return;o=1-n/r}WA.sound.loadSound(t).play({volume:o})}function Le(e){WA.state[e.name]===void 0&&(WA.state[e.name]=0),WA.state.onVariableChange(e.name).subscribe(()=>{WA.state[e.name]&&Pe(e)})}function Ve(e,t,r){let o;const n=t.getString("bellPopup");WA.room.onEnterLayer(r).subscribe(()=>{var s;n?o=WA.ui.openPopup(n,"",[{label:(s=t.getString("bellButtonText"))!==null&&s!==void 0?s:"Ring",callback:()=>{WA.state[e]=WA.state[e]+1}}]):WA.state[e]=WA.state[e]+1}),WA.room.onLeaveLayer(r).subscribe(()=>{o&&(o.close(),o=void 0)})}async function Me(e){e=e??B;const t=await te();U=await x();for(const r of t.values())r.properties.get("door")&&Te(r),r.properties.get("bell")&&Le(r);for(const r of U.values()){const o=new E(r.properties),n=o.getString("doorVariable");if(n&&r.type==="tilelayer"){const i=t.get(n);if(i===void 0)throw new Error('Cannot find variable "'+n+'" referred in the "doorVariable" property of layer "'+r.name+'"');xe(r,i,o,e)}const s=o.getString("bellVariable");s&&Ve(s,o,r.name)}WA.player.onPlayerMove(r=>{R=r.x,O=r.y})}function ke(e,t){const r=e.getString("bindVariable");if(r){const o=e.get("enterValue"),n=e.get("leaveValue"),s=e.getString("triggerMessage"),i=e.getString("tag");je(r,t,o,n,s,i)}}function je(e,t,r,o,n,s){s&&!WA.player.tags.includes(s)||(r!==void 0&&WA.room.onEnterLayer(t).subscribe(()=>{n||(WA.state[e]=r)}),o!==void 0&&WA.room.onLeaveLayer(t).subscribe(()=>{WA.state[e]=o}))}async function Ge(){const e=await x();for(const t of e.values()){const r=new E(t.properties);ke(r,t.name)}}let K;async function Ue(e){const t=await WA.room.getTiledMap();e=e??B,K=await x();const r=t.layers.find(o=>o.name==="configuration");if(r){const o=new E(r.properties).getString("tag");(!o||WA.player.tags.includes(o))&&WA.ui.registerMenuCommand("Configure the room",()=>{WA.nav.openCoWebSite(e+"/configuration.html",!0)});for(const n of K.values()){const s=new E(n.properties),i=s.getString("openConfig");i&&n.type==="tilelayer"&&Be(i.split(","),n.name,s)}}}function Be(e,t,r){let o;const n=r.getString("openConfigAdminTag");let s=!0;n&&!WA.player.tags.includes(n)&&(s=!1);function i(){var c;o&&o.remove(),o=WA.ui.displayActionMessage({message:(c=r.getString("openConfigTriggerMessage"))!==null&&c!==void 0?c:"Press SPACE or touch here to configure",callback:()=>N(e)})}function a(){WA.nav.closeCoWebSite()}WA.room.onEnterLayer(t).subscribe(()=>{const c=r.getString("openConfigTrigger");s&&(c&&c==="onaction"?i():N(e))}),WA.room.onLeaveLayer(t).subscribe(()=>{o&&o.remove(),a()})}function Ie(){return WA.onInit().then(()=>{Me().catch(e=>console.error(e)),Ge().catch(e=>console.error(e)),Ue().catch(e=>console.error(e)),Se().catch(e=>console.error(e)),We().catch(e=>console.error(e))}).catch(e=>console.error(e))}console.log("Script started successfully");let M;WA.onInit().then(()=>{console.log("Scripting API ready"),console.log("Player tags: ",WA.player.tags),WA.room.area.onEnter("clock").subscribe(()=>{const e=new Date,t=e.getHours()+":"+e.getMinutes();M=WA.ui.openPopup("clockPopup","It's "+t,[])}),WA.room.area.onLeave("clock").subscribe(Re),Ie().then(()=>{console.log("Scripting API Extra ready")}).catch(e=>console.error(e))}).catch(e=>console.error(e));function Re(){M!==void 0&&(M.close(),M=void 0)}
